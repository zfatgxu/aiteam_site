# AI智算与数据科学学科团队网站部署指南

## 一、本地构建

### 1.1 构建前端
```bash
cd frontend
npm install
npm run build
```
构建完成后，会在 `frontend/dist` 目录生成静态文件。

### 1.2 构建后端
```bash
cd backend
npm install
npm run build
```
构建完成后，会在 `backend/dist` 目录生成编译后的文件。

## 二、上传到服务器

### 2.1 使用 SCP 上传
```bash
# 上传前端构建文件
scp -r frontend/dist username@aicc.gxu.edu.cn:/var/www/aicc

# 上传后端文件
scp -r backend username@aicc.gxu.edu.cn:/var/www/aicc-backend
```

### 2.2 使用 Git 部署（推荐）
```bash
# 在服务器上
cd /var/www
git clone <your-repository-url> aicc
cd aicc

# 构建前端
cd frontend
npm install --production
npm run build

# 构建后端
cd ../backend
npm install --production
npm run build
```

## 三、服务器环境准备

### 3.1 安装 Node.js
```bash
# 使用 nvm 安装 Node.js 18+
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

### 3.2 安装 PM2（进程管理器）
```bash
npm install -g pm2
```

### 3.3 安装 Nginx
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

## 四、配置后端服务

### 4.1 创建 PM2 配置文件
在项目根目录创建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'aicc-backend',
    script: './backend/dist/main.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    }
  }]
}
```

### 4.2 启动后端服务
```bash
cd /var/www/aicc
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

### 4.3 查看服务状态
```bash
pm2 status
pm2 logs aicc-backend
```

## 五、配置 Nginx

### 5.1 编辑 Nginx 配置
```bash
sudo nano /etc/nginx/nginx.conf
```

### 5.2 在 http 块中添加以下配置

```nginx
http {
    # ... 其他配置保持不变 ...

    # 添加以下 server 配置
    server {
        listen 80;
        server_name aicc.gxu.edu.cn;

        # 前端静态文件
        root /var/www/aicc/frontend/dist;
        index index.html;

        # 启用 gzip 压缩
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
        gzip_min_length 1000;

        # 前端路由配置（Vue Router history 模式）
        location / {
            try_files $uri $uri/ /index.html;
        }

        # 后端 API 代理
        location /api {
            proxy_pass http://localhost:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
}
```

### 5.3 测试 Nginx 配置
```bash
sudo nginx -t
```

### 5.4 重启 Nginx
```bash
sudo systemctl restart nginx
```

### 5.5 设置 Nginx 开机自启
```bash
sudo systemctl enable nginx
```

## 六、配置 HTTPS（可选但推荐）

### 6.1 安装 Certbot
```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx
```

### 6.2 获取 SSL 证书
```bash
sudo certbot --nginx -d aicc.gxu.edu.cn
```

### 6.3 自动续期
```bash
sudo certbot renew --dry-run
```

Certbot 会自动修改 Nginx 配置，添加 HTTPS 支持。

## 七、防火墙配置

### 7.1 开放端口
```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 'Nginx Full'
sudo ufw allow OpenSSH
sudo ufw enable

# CentOS/RHEL (Firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

## 八、更新部署

### 8.1 更新代码
```bash
cd /var/www/aicc
git pull origin main
```

### 8.2 重新构建前端
```bash
cd frontend
npm install
npm run build
```

### 8.3 重新构建并重启后端
```bash
cd ../backend
npm install
npm run build
pm2 restart aicc-backend
```

## 九、监控和维护

### 9.1 查看后端日志
```bash
pm2 logs aicc-backend
```

### 9.2 查看 Nginx 日志
```bash
# 访问日志
sudo tail -f /var/log/nginx/access.log

# 错误日志
sudo tail -f /var/log/nginx/error.log
```

### 9.3 重启服务
```bash
# 重启后端
pm2 restart aicc-backend

# 重启 Nginx
sudo systemctl restart nginx
```

## 十、故障排查

### 10.1 后端无法启动
```bash
# 检查端口占用
sudo netstat -tulpn | grep 3001

# 查看详细日志
pm2 logs aicc-backend --lines 100
```

### 10.2 前端页面无法访问
```bash
# 检查 Nginx 状态
sudo systemctl status nginx

# 检查文件权限
ls -la /var/www/aicc/frontend/dist

# 修复权限
sudo chown -R www-data:www-data /var/www/aicc/frontend/dist
```

### 10.3 API 请求失败
```bash
# 测试后端服务
curl http://localhost:3001/api

# 检查 Nginx 代理配置
sudo nginx -t
```

## 十一、性能优化建议

### 11.1 启用 HTTP/2
在 Nginx 配置中：
```nginx
listen 443 ssl http2;
```

### 11.2 配置缓存
```nginx
# 在 http 块中添加
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m;

# 在 location /api 中添加
proxy_cache api_cache;
proxy_cache_valid 200 10m;
```

### 11.3 限流配置
```nginx
# 在 http 块中添加
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# 在 location /api 中添加
limit_req zone=api_limit burst=20 nodelay;
```

## 十二、备份策略

### 12.1 数据库备份（如果使用）
```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup.sh
```

### 12.2 代码备份
```bash
# 定期提交到 Git
cd /var/www/aicc
git add .
git commit -m "Production backup $(date +%Y%m%d)"
git push
```

## 联系方式

如有问题，请联系技术支持：
- 邮箱：tech@gxu.edu.cn
- 电话：+86 10 1234 5678
